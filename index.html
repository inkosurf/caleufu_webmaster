<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cargar publicación</title>
  <style>
    body { font-family: sans-serif; max-width: 680px; margin: 24px auto; padding: 0 12px; }
    form { display: grid; gap: 12px; }
    input, textarea, button { padding: 10px; font-size: 16px; }
    .ok { color: #0a7c2f; } .err { color: #b00020; }
  </style>
</head>
<body>
  <h1>Cargar publicación</h1>

  <form id="pubForm">
    <div><label>Imagen</label> <input type="file" id="imgFile" accept="image/*" required /></div>
    <div><label>Título</label> <input type="text" id="titulo" required /></div>
    <div><label>Autor</label> <input type="text" id="autor" required /></div>
    <div><label>Descripción</label> <textarea id="descripcion" rows="4" required></textarea></div>
    <div><label>Link</label> <input type="url" id="link" placeholder="https://..." /></div>
    <button type="submit">Guardar</button>
  </form>

  <p id="status"></p>

  <script type="module">
    // === IMPORTS (CDN) — usa una sola versión consistente ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // === TU CONFIG — OJO storageBucket termina en appspot.com ===
    const firebaseConfig = {
      apiKey: "AIzaSyDEpsW78ANRpnTQ9fZkwPQBUhYZVP2xw18",
      authDomain: "caleufuyerbamate.firebaseapp.com",
      databaseURL: "https://caleufuyerbamate-default-rtdb.firebaseio.com",
      projectId: "caleufuyerbamate",
      storageBucket: "caleufuyerbamate.firebasestorage.app",
      messagingSenderId: "690153593667",
      appId: "1:690153593667:web:b5f9d936f59f3c6336edf6"
      // measurementId opcional: no lo usamos
    };

    // === INIT
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // === FORM LOGIC
    const form = document.getElementById("pubForm");
    const statusEl = document.getElementById("status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "Subiendo..."; statusEl.className = "";
      try {
        const imgFile = document.getElementById("imgFile").files[0];
        const titulo = document.getElementById("titulo").value.trim();
        const autor = document.getElementById("autor").value.trim();
        const descripcion = document.getElementById("descripcion").value.trim();
        const link = document.getElementById("link").value.trim();

        if (!imgFile) throw new Error("Falta la imagen");

        // 1) subir imagen
        const path = `publicaciones/${Date.now()}_${imgFile.name}`;
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, imgFile);
        const imagenURL = await getDownloadURL(storageRef);

        // 2) guardar doc
        await addDoc(collection(db, "publicaciones"), {
          titulo, autor, descripcion, link: link || null,
          imagenURL, fecha: serverTimestamp()
        });

        form.reset();
        statusEl.textContent = "✅ Publicación guardada"; statusEl.className = "ok";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ " + (err.message || err); statusEl.className = "err";
      }
    });
  </script>
</body>
</html>
